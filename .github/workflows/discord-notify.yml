name: Notify Discord after CI

on:
    workflow_run:
        workflows: ['ci phase']
        types:
            - completed

jobs:
    discord-notify:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion != 'skipped' }}

        steps:
            - name: Set status icon
              id: result
              run: |
                  if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
                    echo "status=âœ… CI Passed ðŸŽ‰" >> $GITHUB_OUTPUT
                    echo "color=3066993" >> $GITHUB_OUTPUT
                  else
                    echo "status=âŒ CI Failed ðŸ’¥" >> $GITHUB_OUTPUT
                    echo "color=15158332" >> $GITHUB_OUTPUT
                  fi

            - name: Send to Discord
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
                  STATUS: ${{ steps.result.outputs.status }}
                  COLOR: ${{ steps.result.outputs.color }}
                  TITLE: ${{ github.event.workflow_run.display_title }}
                  COMMIT_MSG: ${{ github.event.workflow_run.head_commit.message }}
                  REPO: ${{ github.repository }}
                  COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
                  USER: ${{ github.event.sender.login }}
              run: |
                  TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
                  PR_URL="https://github.com/${REPO}/pulls?q=sha:${COMMIT_SHA}"

                  curl -X POST "$DISCORD_WEBHOOK" \
                    -H "Content-Type: application/json" \
                    -d @- <<EOF
                  {
                    "content": "@everyone",
                    "embeds": [
                      {
                        "title": "ðŸš€ ${STATUS}",
                        "url": "${PR_URL}",
                        "description": "ðŸ“¦ **Commit**: \`${COMMIT_MSG}\`\nðŸ”§ **Workflow**: \`${TITLE}\`\nðŸ‘¤ **User**: [${USER}](https://github.com/${USER})",
                        "color": ${COLOR},
                        "author": {
                          "name": "${USER}",
                          "url": "https://github.com/${USER}",
                          "icon_url": "https://github.com/${USER}.png"
                        },
                        "thumbnail": {
                          "url": "https://cdn-icons-png.flaticon.com/512/906/906334.png"
                        },
                        "footer": {
                          "text": "ðŸ•’ CI finished at ${TIMESTAMP} â€¢ ðŸ™ GitHub Actions"
                        }
                      }
                    ]
                  }
                  EOF
