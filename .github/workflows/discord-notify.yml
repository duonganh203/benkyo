name: Notify Discord after CI

on:
    workflow_run:
        workflows: ['ci phase']
        types:
            - completed

jobs:
    discord-notify:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion != 'skipped' }}

        steps:
            - name: Set status icon
              id: result
              run: |
                  if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
                    echo "status=âœ… CI Passed ðŸŽ‰" >> $GITHUB_OUTPUT
                    echo "color=3066993" >> $GITHUB_OUTPUT
                  else
                    echo "status=âŒ CI Failed ðŸ’¥" >> $GITHUB_OUTPUT
                    echo "color=15158332" >> $GITHUB_OUTPUT
                  fi

            - name: Get PR URL via GitHub API
              id: pr
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SHA: ${{ github.event.workflow_run.head_sha }}
                  REPO: ${{ github.repository }}
              run: |
                  PR_API_URL="https://api.github.com/repos/${REPO}/commits/${SHA}/pulls"
                  PR_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.groot-preview+json" "$PR_API_URL")
                  PR_URL=$(echo "$PR_JSON" | jq -r '.[0].html_url')
                  echo "url=$PR_URL" >> $GITHUB_OUTPUT

            - name: Send to Discord
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
                  STATUS: ${{ steps.result.outputs.status }}
                  COLOR: ${{ steps.result.outputs.color }}
                  TITLE: ${{ github.event.workflow_run.display_title }}
                  COMMIT_MSG: ${{ github.event.workflow_run.head_commit.message }}
                  USER: ${{ github.event.sender.login }}
                  PR_URL: ${{ steps.pr.outputs.url }}
              run: |
                  TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

                  curl -X POST "$DISCORD_WEBHOOK" \
                    -H "Content-Type: application/json" \
                    -d @- <<EOF
                  {
                    "content": "@everyone",
                    "embeds": [
                      {
                        "title": "ðŸš€ ${STATUS}",
                        "url": "${PR_URL}",
                        "description": "ðŸ§ª **Workflow**: \`${TITLE}\`\nðŸ“¦ **Commit**: \`${COMMIT_MSG}\`\nðŸ‘¤ **Author**: [${USER}](https://github.com/${USER})",
                        "color": ${COLOR},
                        "author": {
                          "name": "${USER}",
                          "url": "https://github.com/${USER}",
                          "icon_url": "https://github.com/${USER}.png"
                        },
                        "thumbnail": {
                          "url": "https://cdn-icons-png.flaticon.com/512/906/906334.png"
                        },
                        "footer": {
                          "text": "ðŸ•’ CI finished at ${TIMESTAMP} â€¢ ðŸ™ GitHub Actions"
                        }
                      }
                    ]
                  }
                  EOF
